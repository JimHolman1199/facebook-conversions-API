___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "FB conversion API",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/jpeg;base64,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\u003d\u003d"
  },
  "description": "Send conversions to Facebook using Conversions API from the GTM web client",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "pixel_id",
    "displayName": "Facebook Pixel ID",
    "simpleValueType": true,
    "valueHint": "e.g. 12345678910",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "REGEX",
        "args": [
          "^[0-9,]+$"
        ]
      }
    ],
    "defaultValue": "{{Facebook - Pixel ID}}"
  },
  {
    "type": "TEXT",
    "name": "client",
    "displayName": "Predefined client name",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "defaultValue": "{{FB - conversion api - token key}}"
  },
  {
    "type": "LABEL",
    "name": "event_name",
    "displayName": "Event Name"
  },
  {
    "type": "TEXT",
    "name": "eventName",
    "displayName": "",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "LABEL",
    "name": "event_id",
    "displayName": "Event ID"
  },
  {
    "type": "TEXT",
    "name": "eventID",
    "simpleValueType": true,
    "displayName": "",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "defaultValue": "{{Unique Event ID}}"
  },
  {
    "type": "GROUP",
    "name": "userData",
    "displayName": "User data",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "userDataObj",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "User data",
            "name": "name",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "email",
                "displayValue": "Email"
              },
              {
                "value": "phone",
                "displayValue": "Phone"
              },
              {
                "value": "firstName",
                "displayValue": "First name"
              },
              {
                "value": "lastName",
                "displayValue": "Last name"
              }
            ],
            "valueValidators": []
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "valueValidators": []
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "customData",
    "displayName": "Custom data",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "customDataObj",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Custom data",
            "name": "name",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "order_id",
                "displayValue": "Order ID"
              },
              {
                "value": "value",
                "displayValue": "Value"
              },
              {
                "value": "currency",
                "displayValue": "Currency"
              },
              {
                "value": "productsArr",
                "displayValue": "Product Array"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "customProp",
    "displayName": "Custom Properties",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "customPropObj",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Property Name",
            "name": "name",
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Property Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "newRowButtonText": "Add property"
      },
      {
        "type": "SELECT",
        "name": "objectPropertiesFromVariable",
        "displayName": "Load Properties From Variable",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": false,
            "displayValue": "False"
          }
        ],
        "simpleValueType": true,
        "help": "You can use a variable that returns a JavaScript object with the properties you want to use. This object will be merged with any additional properties you add via the table below. Any conflicts will be resolved in favor of the properties you add to the table."
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Enter your template code here.
const log = require('logToConsole');
const getCookieValues = require('getCookieValues');
const callInWindow = require('callInWindow');
const getUrl = require('getUrl');
const injectScript = require('injectScript');
const queryPermission = require('queryPermission');

log('data =', data);
const postScriptUrl = 'https://afternoon-journey-05311.herokuapp.com/api/cdn/request.js';
const URL = 'https://afternoon-journey-05311.herokuapp.com/api/facebook/event';

const modifyData = (arr) => {
  return arr.map(el => {
    const obj = {};
    obj[el.name] = el.value;
    return obj;
  });
};

const mergeObj = (arr) => {
  if(!arr) {
    return {};
  }
  const arrObj = modifyData(arr);
  return arrObj.reduce(function(acc, x) {
    for (var key in x) acc[key] = x[key];
    return acc;
  }, {});
};

const mergeTwoObj = (obj, obj2) => {
  obj = obj || {};
  obj2 = obj2 || {};
  for (let key in obj2) {
    if (obj2.hasOwnProperty(key)) {
      obj[key] = obj2[key];
    }
  }
  return obj;
};


const payload = {
  client: data.client,
  pixel_id: data.pixel_id,
  user: mergeTwoObj(
    mergeObj(data.userDataObj),
  {
      eventName: data.eventName,
      fbp: getCookieValues('_fbp')[0],
      fbc: getCookieValues('_fbc')[0],
      sourceUrl: getUrl()
   }),
   customData: mergeTwoObj(mergeObj(data.customDataObj), {
       event_id: data.eventID,
       customProp: mergeObj(data.customPropObj)
   })
};

const onSuccess = () => {
  if (queryPermission('access_globals', 'execute','sendRequest')){
    const response = callInWindow('sendRequest', 'POST', URL, payload);
    log('response', response);
    data.gtmOnSuccess();
  } else{
    data.gtmOnFailure();
  }
};

const onFailure = () => {
  log('Conductrics: Script load failed.');
  data.gtmOnFailure();
};

if (queryPermission('inject_script', postScriptUrl)) {
  injectScript(postScriptUrl, onSuccess, onFailure, postScriptUrl);
} else {
  log('Conductrics: Script load failed due to permissions mismatch.');
  data.gtmOnFailure();
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "sendData"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "sendRequest"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://afternoon-journey-05311.herokuapp.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 12/21/2021, 9:46:19 AM


